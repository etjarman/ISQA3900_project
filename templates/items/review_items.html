{% extends "items/base.html" %}

{% block content %}
<div class="container mt-4">
  <h1>Pending & Approved Items Review</h1>

  {% if messages %}
    <div class="mt-2">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post" class="mt-3">
    {% csrf_token %}

    <!-- ===================== PENDING ITEMS ===================== -->
    <h2>Pending Items</h2>

    <div class="mb-2">
      <button type="submit" name="action" value="approve" class="btn btn-primary btn-sm">
        Approve selected
      </button>
    </div>

    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th scope="col">
            <input type="checkbox" id="select-all-pending">
          </th>
          <th scope="col">Title</th>
          <th scope="col">Status</th>
          <th scope="col">Category</th>
          <th scope="col">Building</th>
          <th scope="col">Date</th>
          <th scope="col">Potential Matches</th>
        </tr>
      </thead>
      <tbody>
        {% for row in items_with_matches %}
          {% with item=row.item matches=row.matches %}
          <tr>
            <td>
              <input type="checkbox" name="item_ids" value="{{ item.id }}" class="pending-checkbox">
            </td>
            <td>
              <a href="{% url 'items:item_detail' item.id %}">
                {{ item.title }}
              </a>
            </td>
            <td>{{ item.status }}</td>
            <td>{{ item.category }}</td>
            <td>{{ item.building|default:"â€”" }}</td>
            <td>{{ item.date_lost_or_found|date:"Y-m-d" }}</td>
            <td style="max-width: 280px;">
              {% if matches %}
                <ul class="mb-0 small">
                  {% for m in matches %}
                    <li>
                      <strong>{{ m.item.status }}:</strong>
                      <a href="{% url 'items:item_detail' m.item.id %}">
                        {{ m.item.title }}
                      </a><br>
                      <span class="text-muted">
                        Score: {{ m.score }}
                        {% if m.item.building %}
                          | {{ m.item.building }}
                        {% endif %}
                        {% if m.item.date_lost_or_found %}
                          | {{ m.item.date_lost_or_found|date:"Y-m-d" }}
                        {% endif %}
                      </span>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-muted small">No strong matches yet</span>
              {% endif %}
            </td>
          </tr>
          {% endwith %}
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">
            No pending items to review ðŸŽ‰
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- ===================== APPROVED ITEMS & MATCHES ===================== -->
    <h2 class="mt-4">Approved Items & Matches</h2>

    <p class="muted">
      Use the dropdowns below to set each match status to Pending, Confirmed, or Rejected.
      Click "Save match changes" when you're done.
    </p>

    <div class="mb-2">
      <button type="submit" name="action" value="save_matches" class="btn btn-success btn-sm">
        Save match changes
      </button>
    </div>

    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Item</th>
          <th>Status</th>
          <th>Category</th>
          <th>Building</th>
          <th>Date</th>
          <th>Matches</th>
        </tr>
      </thead>
      <tbody>
        {% for row in approved_items_with_matches %}
          {% with item=row.item matches=row.matches %}
          <tr>
            <td>
              <a href="{% url 'items:item_detail' item.id %}">
                {{ item.title }}
              </a>
            </td>
            <td>{{ item.status }}</td>
            <td>{{ item.category }}</td>
            <td>{{ item.building|default:"â€”" }}</td>
            <td>{{ item.date_lost_or_found|date:"Y-m-d" }}</td>
            <td>
                {% if matches %}
                    <table class="table table-sm small mb-0">
                        <thead>
                        <tr>
                            <th>Other item(s)</th>
                            <th>Score</th>
                            <th>Why?</th>
                            <th>Match status</th>
                            <th>Notify</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for match in matches %}
                            <tr>
                                <td>
                                    Lost:
                                    <a href="{% url 'items:item_detail' match.lost_item.id %}">
                                        {{ match.lost_item.title }}
                                    </a><br>
                                    Found:
                                    <a href="{% url 'items:item_detail' match.found_item.id %}">
                                        {{ match.found_item.title }}
                                    </a>
                                </td>

                                <td><strong>{{ match.score }}</strong></td>

                                <td style="min-width:220px;">
                                    {% if match.score_breakdown %}
                                        <details>
                                            <summary>View breakdown</summary>
                                            <ul style="margin:.25rem 0 0 1rem;">
                                                <li>Building: {{ match.score_breakdown.building }}</li>
                                                <li>Color: {{ match.score_breakdown.color }}</li>
                                                <li>Brand/Model tokens: {{ match.score_breakdown.brand_model_tokens }}</li>
                                                <li>Title/Desc fuzzy: {{ match.score_breakdown.title_desc_fuzzy }}</li>
                                                <li>Date proximity: {{ match.score_breakdown.date_proximity }}</li>
                                                <li>Room tokens: {{ match.score_breakdown.room_tokens }}</li>
                                                <li><strong>Total:</strong> {{ match.score_breakdown.total }}</li>
                                            </ul>
                                        </details>
                                    {% else %}
                                        <span class="text-muted">No breakdown saved</span>
                                    {% endif %}
                                </td>

                                <td>
                                    <select name="match_status_{{ match.id }}">
                                        <option value="">(no change)</option>
                                        <option value="PENDING"  {% if match.status == "PENDING"  %}selected{% endif %}>Pending</option>
                                        <option value="CONFIRMED" {% if match.status == "CONFIRMED" %}selected{% endif %}>Confirmed</option>
                                        <option value="REJECTED" {% if match.status == "REJECTED" %}selected{% endif %}>Rejected</option>
                                    </select>
                                </td>

                                <td>
                                    {% if match.status == "CONFIRMED" %}
                                        <a href="{% url 'items:notify_match' match.id %}">Notify</a>
                                    {% else %}
                                        <span class="text-muted">â€”</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <span class="text-muted small">No matches recorded yet.</span>
                {% endif %}

            </td>
          </tr>
          {% endwith %}
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">
            No approved items with matches yet.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Django admin link -->
    <div class="muted" style="margin-top:1.5rem; text-align:right;">
      Need full tools? <a href="{% url 'admin:index' %}">Open Django admin</a>.
    </div>

  </form>
</div>

<script>
  (function() {
    const selectAll = document.getElementById("select-all-pending");
    if (!selectAll) return;
    selectAll.addEventListener("change", function() {
      const checked = this.checked;
      document.querySelectorAll('.pending-checkbox').forEach(function(cb) {
        cb.checked = checked;
      });
    });
  })();
</script>
{% endblock %}
